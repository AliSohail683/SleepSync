# Sleep Algorithms

This document describes the algorithms used in SleepSync for sleep tracking, scoring, and optimization.

## Sleep Score Calculation

The sleep score is calculated using a multi-factor algorithm that considers various aspects of sleep quality.

### Formula

```
Base Score = min(100, (actual_hours / goal_hours) * 100)

Adjustments:
- Wake events penalty: -5 points per event (if > 2 events)
- Quick sleep onset bonus: +3 points (if < 20 minutes)
- Slow sleep onset penalty: -5 points (if > 45 minutes)
- High caffeine penalty: -10 points
- Deep sleep bonus: +5 points (if 15-25% of total)
- REM sleep bonus: +5 points (if 20-30% of total)

Final Score = clamp(Base Score + Adjustments, 0, 100)
```

### Implementation

See `src/utils/sleepUtils.ts:calculateSleepScore()`

```typescript
export const calculateSleepScore = (
  session: SleepSession,
  sleepGoalHours: number,
  caffeineHabits: string
): number => {
  const actualHours = session.durationMin / 60;
  let score = Math.min(100, (actualHours / sleepGoalHours) * 100);

  // Apply penalties and bonuses
  if (session.awakeCount && session.awakeCount > 2) {
    score -= 5 * (session.awakeCount - 2);
  }

  if (session.sleepLatency && session.sleepLatency < 20) {
    score += 3;
  } else if (session.sleepLatency && session.sleepLatency > 45) {
    score -= 5;
  }

  if (caffeineHabits === 'high') {
    score -= 10;
  }

  // Stage quality bonuses
  if (session.stages) {
    const deepPercent = session.stages.deep / actualHours;
    const remPercent = session.stages.rem / actualHours;
    
    if (deepPercent >= 0.15 && deepPercent <= 0.25) score += 5;
    if (remPercent >= 0.20 && remPercent <= 0.30) score += 5;
  }

  return Math.max(0, Math.min(100, Math.round(score)));
};
```

### Score Categories

| Score Range | Category | Emoji |
|-------------|----------|-------|
| 90-100 | Excellent | ðŸŒŸ |
| 75-89 | Good | ðŸ˜Š |
| 60-74 | Fair | ðŸ˜ |
| 0-59 | Poor | ðŸ˜´ |

## Sleep Stage Estimation

SleepSync simulates sleep stages based on typical sleep architecture patterns.

### Sleep Cycles

A typical sleep cycle lasts ~90 minutes and consists of:

1. **Light Sleep (N1/N2)**: 20 minutes (22%)
2. **Deep Sleep (N3)**: 30 minutes (33%)
3. **Light Sleep (N2)**: 20 minutes (22%)
4. **REM Sleep**: 20 minutes (22%)

### Algorithm

```typescript
export const estimateSleepStages = (durationMin: number) => {
  const hours = durationMin / 60;
  const jitter = () => (Math.random() - 0.5) * 0.1;
  
  const deep = hours * (0.20 + jitter());
  const rem = hours * (0.25 + jitter());
  const light = hours - deep - rem;
  
  return { light, deep, rem };
};
```

### Stage Distribution

| Stage | Typical % | Hours (8h sleep) |
|-------|-----------|------------------|
| Light | 50-55% | 4-4.4h |
| Deep | 15-25% | 1.2-2h |
| REM | 20-25% | 1.6-2h |

## Smart Alarm Algorithm

The smart alarm wakes you during light sleep within your target window.

### Approach

1. **Predict Sleep Stages**: Generate predicted stage timeline
2. **Find Light Sleep Moments**: Identify all light sleep phases in window
3. **Select Optimal Time**: Choose earliest light sleep moment
4. **Fallback**: Use window start if no light sleep detected

### Implementation

```typescript
export const computeWakeMoment = (
  windowStart: string,
  windowEnd: string,
  predictedStages?: Array<{ time: Date; stage: 'light' | 'deep' | 'rem' }>
): Date => {
  const startDate = parseTime(windowStart);
  const endDate = parseTime(windowEnd);

  if (predictedStages) {
    const lightSleepMoments = predictedStages.filter(
      s => s.stage === 'light' && s.time >= startDate && s.time <= endDate
    );

    if (lightSleepMoments.length > 0) {
      return lightSleepMoments[0].time; // Earliest
    }
  }

  return startDate; // Fallback
};
```

### Stage Prediction

Uses a 90-minute cycle model:

```
Cycle Pattern: Light (20m) â†’ Deep (30m) â†’ Light (20m) â†’ REM (20m)
```

## Sleep Debt Calculation

Sleep debt accumulates when you don't get your target sleep hours.

### Daily Debt

```
daily_debt = max(0, ideal_hours - actual_hours)
```

### Cumulative Debt

```
weekly_debt = sum(daily_debt for last 7 days)
monthly_debt = sum(daily_debt for last 30 days)
```

### Debt Categories

| Debt (hours) | Severity | Impact |
|--------------|----------|--------|
| 0-2 | Optimal | Minimal |
| 3-6 | Moderate | Noticeable |
| 7+ | Severe | Significant |

### Recovery Recommendations

- **Moderate Debt (3-6h)**: Get extra 1-2 hours over next few nights
- **Severe Debt (7+h)**: Consider taking a nap, sleeping in on weekend

## Sleep Insights Generation

Insights are generated by analyzing patterns in sleep data.

### Duration Insight

```typescript
if (avgDuration < sleepGoal - 1) {
  return {
    type: 'duration',
    severity: 'warning',
    title: 'Sleep Duration Below Goal',
    recommendation: 'Try going to bed 30 minutes earlier tonight.'
  };
}
```

### Consistency Insight

Uses standard deviation of bedtimes:

```
variance = sum((bedtime - avg_bedtime)^2) / n

if (variance > 4) {
  // High inconsistency warning
}
```

### Quality Insight

Based on average sleep score:

```
if (avgScore >= 90) {
  // Excellent quality
} else if (avgScore < 60) {
  // Poor quality warning
}
```

## Temperature Optimization

Optimal sleep temperature: **15-19Â°C (60-67Â°F)**

### Recommendation Logic

```typescript
if (currentTemp > 19) {
  recommend = 19;
  reason = "Room is too warm. Cooler temps promote deeper sleep.";
  impact = "high";
} else if (currentTemp < 15) {
  recommend = 15;
  reason = "Room may be too cold. Slight warming may help.";
  impact = "medium";
}
```

## Soundscape Personalization

AI selects soundscape based on user preferences and sleep quality.

### Selection Logic

```typescript
if (noiseSensitivity === 'high') {
  baseType = 'white'; // Consistent masking
} else if (avgSleepScore < 60) {
  baseType = 'ocean'; // More calming
} else {
  baseType = 'brown'; // Deep, soothing
}
```

### Blending

Multiple sound layers can be mixed:

```
blend = [
  { type: 'rain', level: 0.7 },
  { type: 'ocean', level: 0.3 }
]

normalized_volume(layer) = layer.level / sum(all_levels)
```

## References

- National Sleep Foundation: [sleepfoundation.org](https://www.sleepfoundation.org/)
- NIH Sleep Research: [nhlbi.nih.gov](https://www.nhlbi.nih.gov/health/sleep)
- Sleep Stages: [aasm.org](https://aasm.org/)

## Testing

All algorithms are unit tested. See `tests/utils/sleepUtils.test.ts`.

```bash
npm test -- sleepUtils
```

## Future Enhancements

- Machine learning for personalized scoring
- Integration with wearable devices for real-time stage detection
- Adaptive algorithms based on historical data
- Seasonal and environmental factor adjustments

